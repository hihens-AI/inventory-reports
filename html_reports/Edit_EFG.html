<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編輯機台: EFG</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        .field { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 10px; }
        button:disabled { background-color: #ccc; }
        #status { margin-top: 15px; text-align: center; font-weight: bold; }
        #token-input-container { margin-bottom: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 5px; background: #e9ffea; transition: border-color 0.3s; }
        .token-group { display: flex; gap: 5px; margin-top: 5px;}
        .paste-btn { width: 30%; max-width: 150px; padding: 10px; background-color: #f39c12; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; flex-shrink: 0; }
        .paste-btn:hover { background-color: #e67e22; }
        /* 優化手機顯示 */
        @media (max-width: 600px) {
            .container { padding: 15px; border-radius: 0; }
            body { padding: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>機台資料編輯 (手機)</h2>
        <div style="text-align:center; color:blue; margin-bottom:10px;">Part No: EFG</div>

        <div id="token-input-container">
            <label>GitHub Token 狀態: <span id="token-status-text">載入中...</span></label>
            <div class="token-group">
                <input type="password" id="githubToken" 
                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
                       autocomplete="current-password" 
                       style="flex-grow: 1;">
                <button type="button" class="paste-btn" onclick="pasteToken()">從剪貼簿貼上</button>
            </div>
            <div style="font-size:12px; color:#555; margin-top:5px;">(若 Token 已儲存，此欄位會自動填充，只需點擊儲存修改)</div>
        </div>

        <div id="form-container">
            
        <div class="field">
            <label>請領單號 (Requisition No)</label>
            <input type="text" id="請領單號_(Requisition_No)" data-field-name="請領單號 (Requisition No)" value="EFG" >
        </div>
        <div class="field">
            <label>Part No</label>
            <input type="text" id="Part_No" data-field-name="Part No" value="EFG" readonly style="background:#e9ecef;">
        </div>
        <div class="field">
            <label>Applicant</label>
            <input type="text" id="Applicant" data-field-name="Applicant" value="EFG" >
        </div>
        <div class="field">
            <label>Applicant Department</label>
            <input type="text" id="Applicant_Department" data-field-name="Applicant Department" value="" >
        </div>
        <div class="field">
            <label>Applicant ID</label>
            <input type="text" id="Applicant_ID" data-field-name="Applicant ID" value="" >
        </div>
        <div class="field">
            <label>Qty Apply</label>
            <input type="text" id="Qty_Apply" data-field-name="Qty Apply" value="" >
        </div>
        <div class="field">
            <label>Location</label>
            <input type="text" id="Location" data-field-name="Location" value="" >
        </div>
        <div class="field">
            <label>Reason</label>
            <input type="text" id="Reason" data-field-name="Reason" value="" >
        </div>
        <div class="field">
            <label>Cost ID</label>
            <input type="text" id="Cost_ID" data-field-name="Cost ID" value="" >
        </div>
        <div class="field">
            <label>Process Date</label>
            <input type="text" id="Process_Date" data-field-name="Process Date" value="" >
        </div>
        <div class="field">
            <label>Remark</label>
            <input type="text" id="Remark" data-field-name="Remark" value="" >
        </div>
        </div>
        <button id="saveBtn" onclick="saveData()">儲存修改</button>
        <div id="status"></div>
    </div>

    <script>
        const USER = "hihens-AI";
        const REPO = "Inventory-Reports";
        const FILE_PATH = "machine_inventory.csv";
        const TARGET_PART_NO = "EFG";
        const FIELDS = ["\u8acb\u9818\u55ae\u865f (Requisition No)", "Part No", "Applicant", "Applicant Department", "Applicant ID", "Qty Apply", "Location", "Reason", "Cost ID", "Process Date", "Remark"];
        const TOKEN_STORAGE_KEY = 'github_pat_inventory_app'; // Local Storage Key

        // ==================== Token 相關操作 (安全版本) ====================

        // 頁面載入時自動從 Local Storage 讀取 Token
        document.addEventListener('DOMContentLoaded', () => {
            const storedToken = localStorage.getItem(TOKEN_STORAGE_KEY);
            const tokenInput = document.getElementById('githubToken');
            const tokenContainer = document.getElementById('token-input-container');
            const statusText = document.getElementById('token-status-text');

            if (storedToken) {
                tokenInput.value = storedToken;
                tokenContainer.style.borderColor = '#28a745';
                statusText.innerText = '已載入並自動保存';
            } else {
                tokenContainer.style.borderColor = '#dc3545';
                statusText.innerText = '未載入，請手動輸入';
            }
        });

        // 嘗試從剪貼簿貼上 Token
        async function pasteToken() {
            try {
                // 為了兼容性，提示使用者長按輸入框手動貼上
                alert('為了瀏覽器安全，無法自動讀取剪貼簿。

請長按「輸入框」並點選「貼上」手動完成。');

            } catch (err) {
                alert('無法自動讀取剪貼簿，請手動貼上 Token。 (瀏覽器安全限制)');
            }
        }

        // ==================== CSV 解析與轉義 ====================

        // 轉義 CSV 值（處理逗號和雙引號）
        function escapeCsvValue(val) {
            if (val === null || val === undefined) return "";
            let str = String(val).trim();
            // 如果內容包含逗號、換行符或雙引號，則用雙引號包起來，並將內部的雙引號轉義為兩個雙引號
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                str = str.replace(/"/g, '""');
                return `"{str}"`;
            }
            return str;
        }

        // 解析 CSV 行（處理雙引號內的逗號）
        function parseCsvRow(row) {
            let values = [];
            let inQuotes = false;
            let currentVal = '';
            let line = row.trim();
            if (!line) return [];

            for (let i = 0; i < line.length; i++) {
                let char = line[i];

                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
                        // 處理內部的雙引號轉義
                        currentVal += '"';
                        i++; 
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(currentVal.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            // 推入最後一個值
            values.push(currentVal.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
            return values;
        }


        // ==================== 儲存邏輯 (核心修正) ====================

        async function saveData() {
            const btn = document.getElementById('saveBtn');
            const status = document.getElementById('status');
            const githubTokenInput = document.getElementById('githubToken');
            const githubToken = githubTokenInput.value.trim();
            const tokenContainer = document.getElementById('token-input-container');
            const statusText = document.getElementById('token-status-text');

            // 在開始處理前先禁用按鈕，防止重複點擊
            btn.innerText = "正在處理中，請稍候...";
            btn.disabled = true;
            status.innerText = "";
            status.style.color = "black";

            if (!githubToken) {
                status.innerText = "錯誤: 請輸入 GitHub Token！";
                status.style.color = "red";
                btn.innerText = "儲存修改";
                btn.disabled = false;
                tokenContainer.style.borderColor = '#dc3545';
                statusText.innerText = '未載入，請手動輸入';
                return;
            }

            // 關鍵步驟：如果 Token 有效，將其儲存到 Local Storage
            localStorage.setItem(TOKEN_STORAGE_KEY, githubToken);
            tokenContainer.style.borderColor = '#28a745';
            statusText.innerText = '已載入並自動保存';

            const authHeaders = { 
                "Authorization": `token ${githubToken}`, 
                "Accept": "application/vnd.github.v3+json" 
            };

            try {
                // 1. 取得目前的檔案 SHA (需要 Token)
                status.innerText = "1/3 正在驗證 Token 並取得檔案 SHA...";
                // GET API 取得包含 SHA 的 JSON
                const getUrl = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}?t=${new Date().getTime()}`;
                const contentResp = await fetch(getUrl, { headers: authHeaders }); 

                if (!contentResp.ok) {
                    const errorJson = await contentResp.json();
                    if (contentResp.status === 401 || contentResp.status === 403) {
                        localStorage.removeItem(TOKEN_STORAGE_KEY);
                        tokenContainer.style.borderColor = '#dc3545';
                        statusText.innerText = 'Token 驗證失敗，已清除。請重新輸入';
                        throw new Error(`Token 驗證失敗 (${contentResp.status})。請確認 Token 是否有效或權限是否足夠！`);
                    }
                    throw new Error("無法取得 GitHub 檔案 SHA (" + contentResp.status + ")。訊息: " + (errorJson.message || "請檢查 Token 是否有效或用戶名是否正確！"));
                }
                const fileData = await contentResp.json();
                const sha = fileData.sha;

                // 2. 解碼檔案內容
                let contentText;
                try {
                    const contentBase64 = fileData.content.replace(/\n/g, ''); // 移除 GitHub API 返回內容中的換行符
                    contentText = decodeURIComponent(escape(atob(contentBase64)));
                } catch (e) {
                    throw new Error("無法解碼 GitHub 檔案內容。");
                }

                // 3. 解析 CSV 並更新資料
                status.innerText = "2/3 正在處理本地修改...";
                let lines = contentText.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) throw new Error("遠端 CSV 檔案是空的。");

                let headers = parseCsvRow(lines[0]);
                let newContent = lines[0].trim() + "\n"; 
                let found = false;

                // 收集表單中的新資料
                let newRowData = [];
                document.querySelectorAll('#form-container input').forEach(input => {
                    const fieldName = input.getAttribute('data-field-name');
                    const val = input.value;
                    newRowData.push(escapeCsvValue(val));
                });
                const newRowString = newRowData.join(',');

                // 4. 重新構建 CSV 內容
                for (let i = 1; i < lines.length; i++) {
                    let line = lines[i].trim();
                    if (!line) continue;

                    const values = parseCsvRow(line);
                    const partNoIndex = headers.indexOf('Part No');

                    if (partNoIndex !== -1 && values[partNoIndex] === TARGET_PART_NO) {
                        found = true;
                        newContent += newRowString + "\n"; // 替換舊行
                    } else {
                        newContent += line + "\n"; // 保留舊行
                    }
                }

                if (!found) {
                    throw new Error("在遠端資料庫中找不到此 Part No，無法更新。請在電腦端查詢 Part No 是否被修改或刪除。");
                }

                // 5. 上傳回 GitHub (PUT)
                status.innerText = "3/3 正在上傳更新的資料...";

                // base64 編碼
                const newBase64 = btoa(unescape(encodeURIComponent(newContent)));

                const putUrl = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}`;
                const body = {
                    message: `Mobile Update: ${TARGET_PART_NO} - ${new Date().toLocaleString()}`,
                    content: newBase64,
                    sha: sha,
                    branch: "main"
                };

                const putResp = await fetch(putUrl, {
                    method: "PUT",
                    headers: authHeaders, 
                    body: JSON.stringify(body)
                });

                if (putResp.ok) {
                    status.innerText = "更新成功！頁面將重新載入以同步最新資料，請稍候...";
                    status.style.color = "green";

                    // 關鍵修正：儲存成功後強制重新載入，以取得新的 SHA 和最新的資料
                    setTimeout(() => {
                        window.location.reload(); 
                    }, 2000); 

                } else {
                    const errorJson = await putResp.json();
                    if (putResp.status === 409) {
                        // 處理衝突：提示使用者重新整理或重試
                        status.innerText = "更新衝突 (409 CONFLICT)！請點擊按鈕重試以同步最新版本。";
                    }
                    throw new Error("上傳失敗: " + (errorJson.message || putResp.statusText));
                }

            } catch (e) {
                status.innerText = "錯誤: " + e.message;
                status.style.color = "red";
                btn.innerText = "重試 / 儲存修改";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>